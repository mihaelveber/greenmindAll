name: backend
type: Load Balanced Web Service

# Configuration for your containers and service.
image:
  build:
    dockerfile: backend/Dockerfile
    context: .
  port: 8090

command: sh -c "python manage.py showmigrations --list && python manage.py migrate --plan && python manage.py migrate --noinput && python manage.py populate_esrs && gunicorn config.asgi:application --bind 0.0.0.0:8090 --workers 4 --worker-class uvicorn.workers.UvicornWorker --timeout 120 --access-logfile - --log-level debug"

http:
  path: '/'
  healthcheck:
    path: '/api/healthcheck/'
    success_codes: '200-399'
    port: 8090
    healthy_threshold: 2
    unhealthy_threshold: 3
    interval: 30s
    timeout: 10s
    grace_period: 180s

variables:
  DJANGO_SETTINGS_MODULE: config.settings
  DEBUG: "True"
  DJANGO_LOG_LEVEL: "DEBUG"
  DJANGO_DB_LOG_LEVEL: "WARNING"
  PYTHONUNBUFFERED: "1"
  ALLOWED_HOSTS: api-dev.greenmindai.net,app-dev.greenmindai.net
  CORS_ALLOWED_ORIGINS: https://app-dev.greenmindai.net,https://admin-dev.greenmindai.net
  DB_NAME: postgres
  DB_USER: greenmindai
  DB_HOST: database-1.cb8c8mksqumh.eu-central-1.rds.amazonaws.com
  DB_PORT: "5432"
  REDIS_HOST: redis
  REDIS_PORT: "6379"
  CELERY_BROKER_URL: redis://redis:6379/0
  CELERY_RESULT_BACKEND: redis://redis:6379/0

environments:
  # Development environment #####################################################
  dev:
    count: 1
    deployment:
      rolling: 'default'
    cpu: 2048       # Number of CPU units for the task.
    memory: 4096    # Amount of memory in MiB used by the task.
    platform: linux/x86_64
    exec: true      # Enable running commands in your container.
    env_file: copilot/environments/dev/dev.env
    variables:
      ALLOWED_HOSTS: "*"
    
    network:
      connect: true
      vpc:
        placement: 'private'

  # Production environment #######################################################
  prod:
    count: 2
    deployment:
      rolling: 'default'
    cpu: 2048       # Number of CPU units for the task.
    memory: 4096    # Amount of memory in MiB used by the task.
    platform: linux/x86_64
    exec: true
    env_file: copilot/environments/prod/prod.env
    
    network:
      connect: true
      vpc:
        placement: 'private'
