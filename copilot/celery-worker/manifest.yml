name: celery-worker
type: Backend Service

network:
      connect: true
      vpc:
        placement: 'private'

secrets:
    DATABASE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/DATABASE_URL
    DJANGO_SECRET_KEY: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/DJANGO_SECRET_KEY
    OPENAI_API_KEY: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/OPENAI_API_KEY
    ANTHROPIC_API_KEY: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/ANTHROPIC_API_KEY
    GOOGLE_GEMINI_API_KEY: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/GOOGLE_GEMINI_API_KEY

variables:
  DJANGO_SETTINGS_MODULE: config.settings

environments:
  # Development environment #####################################################
  dev:
    image:
      build:
        dockerfile: ./backend/Dockerfile
        context: .
    command: celery -A config worker --loglevel=info --concurrency=4
    env_file: copilot/environments/dev/dev.env

    cpu: 1024       # Number of CPU units for the task.
    memory: 2048    # Amount of memory in MiB used by the task.
    count: 1        # Number of tasks that should be running in your service.
    exec: true

  # Production environment #######################################################
  prod:
    image:
      build:
        dockerfile: ./backend/Dockerfile
        context: .
    command: celery -A config worker --loglevel=info --concurrency=4
    env_file: copilot/environments/prod/prod.env
    
    cpu: 1024       # Number of CPU units for the task.
    memory: 2048    # Amount of memory in MiB used by the task.
    count: 2        # Number of tasks that should be running in your service.
    exec: true
